<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Departure Board Layout</title>
    <style>
        /* Load the custom font */
        @font-face {
            font-family: 'BlackBox';
            src: url('https://raw.githubusercontent.com/MichaelH12345/Departures1/main/BlackBox_Font.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* Hide scrollbars for the entire page */
        html, body {
            overflow: hidden; /* Hide scrollbars */
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black; /* Set background to black */
            display: flex;
            font-family: 'BlackBox', sans-serif; /* Apply the custom font */
            flex-direction: column; /* Ensure the footer is pushed to the bottom */
        }

        /* Container to hold the 3 sections */
        .container {
            display: flex;
            width: 100%;
            height: calc(100% - 100px); /* Adjust height to accommodate footer */
        }

        /* Each section takes up one-third of the container width */
        .section {
            flex: 1;
            height: 100%;
            position: relative;
            padding: 25px; /* Padding for text positioning */
            color: white; /* Default text color */
            box-sizing: border-box;
        }

        /* Add a vertical line on the right side of the first and second sections */
        .section:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px; /* Thickness of the line */
            height: 100%;
            background-color: grey; /* Grey color for the line */
        }

        /* Styling for the platform text */
        .platform {
            color: yellow;
            font-size: 50px;
        }

        /* Styling for the time text */
        .time-container {
            display: flex;
            align-items: center;
            margin-top: 25px;
            position: relative;
        }

        .time {
            font-size: 70px;
        }

        /* Styling for the status box */
        .status-box {
            font-size: 40px;
            font-weight: bold;
            padding: 0 20px;
            border-radius: 10px;
            line-height: 70px; 
            height: 70px;
            width: 225px; /* Fixed width */
            text-align: center;
            margin-left: 20px;
            position: absolute;
            right: 0px; /* Position 25px from the right of the section */
            top: 0; /* Align with the time */
        }

        /* Styling for the destination text */
        .destination {
            font-size: 70px;
            white-space: pre-wrap; /* Preserve formatting */
            line-height: 1.2;
        }

        /* Container for the TOC and carriages info */
        .info {
            position: absolute;
            top: 375px; /* Position 200px from the top of the section */
            left: 25px; /* Align with the padding of the section */
            right: 25px; /* Maintain padding on the right side */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 35px;
        }

        /* Yellow color for the carriages info */
        .carriages {
            color: yellow;
        }

        /* Styling for the TOC info */
        .toc {
            color: grey;
        }

        /* Styling for no data in carriages */
        .no-data {
            color: black;
        }

        /* Styling for the calling points text box */
        .calling-points {
            position: absolute;
            top: 425px; /* 100px from the top of the section */
            left: 25px; /* 25px from the left of the section */
            width: calc(100% - 50px); /* Full width minus padding */
            max-height: calc(100% - 150px); /* Ensure it doesn't overflow */
            overflow: hidden; /* Remove scroll bar */
            color: white;
            font-size: 45px;
            padding: 0; /* No padding */
        }

        /* Grey rectangle at the bottom of the page */
        .footer {
            background-color: grey;
            color: yellow;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 75px; /* Adjusted font size */
            font-weight: bold;
            text-align: center; /* Center-align text */
            position: absolute; /* Position it absolutely */
            width: 3840px; /* Set width of the footer */
            right: 0;
            bottom: 0; /* Align it to the bottom */
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Section 1 -->
        <div class="section" data-index="3">
            <div class="platform"></div>
            <div class="time-container">
                <div class="time"></div>
                <div class="status-box"></div>
            </div>
            <div class="destination"></div>
            <div class="info">
                <div class="toc"></div>
                <div class="carriages"></div>
            </div>
            <div class="calling-points"></div> <!-- New text box for calling points -->
        </div>
        <!-- Section 2 -->
        <div class="section" data-index="4">
            <div class="platform"></div>
            <div class="time-container">
                <div class="time"></div>
                <div class="status-box"></div>
            </div>
            <div class="destination"></div>
            <div class="info">
                <div class="toc"></div>
                <div class="carriages"></div>
            </div>
            <div class="calling-points"></div> <!-- New text box for calling points -->
        </div>
        <!-- Section 3 -->
        <div class="section" data-index="5">
            <div class="platform"></div>
            <div class="time-container">
                <div class="time"></div>
                <div class="status-box"></div>
            </div>
            <div class="destination"></div>
            <div class="info">
                <div class="toc"></div>
                <div class="carriages"></div>
            </div>
            <div class="calling-points"></div> <!-- New text box for calling points -->
        </div>
    </div>

    <!-- Grey footer with station name -->
    <div class="footer" id="station-footer">
        <span id="station-name">N/A</span>
    </div>

    <script>
    // Function to format time into BST hours and minutes
    function formatTime(timeString) {
        if (!timeString) return 'N/A';
        const date = new Date(timeString);
        const localDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000 + 3600000); // Convert to local time and adjust for BST
        return `${localDate.getHours().toString().padStart(2, '0')}:${localDate.getMinutes().toString().padStart(2, '0')}`;
    }

    // Function to truncate text if it's longer than a given length
    function truncateText(text, length) {
        if (text.length > length) {
            return text.substring(0, length) + '...';
        }
        return text;
    }

    // Variable to store previous calling points and subsequent locations for comparison
    let previousCallingPoints = [];
    let previousSubsequentLocations = [];

    // Function to fetch and update both departures and calling points
    async function updateDepartures(crsCode) {
        try {
            console.log('Fetching data from API...');
            const response = await fetch(`https://national-rail-api.davwheat.dev/staffdepartures/${crsCode}?expand=true`);
            const data = await response.json();

            // Log the entire data to the console for debugging
            console.log('API Data:', data);

            // Update station name in the footer with "Railway Station" and a space after "Welcome to"
            const stationName = data.locationName || '';
            document.getElementById('station-name').textContent = `Live Departures from ${stationName} Railway Station`;

            // Check if data has a property named 'trainServices'
            if (data.trainServices && data.trainServices.length > 0) {
                data.trainServices.forEach((service, index) => {
                    const section = document.querySelector(`.section[data-index="${index}"]`);

                    if (section) {
                        // Platform
                        const platform = service.platform ? `Platform ${service.platform}` : 'Platform N/A';
                        section.querySelector('.platform').textContent = platform;
                        console.log(`Platform for section ${index + 1}: ${platform}`);

                        // Time
                        const time = formatTime(service.std);
                        section.querySelector('.time').textContent = time;
                        console.log(`Time for section ${index + 1}: ${time}`);

                        // Status
                        const statusBox = section.querySelector('.status-box');
                        const std = service.std ? new Date(service.std).getTime() : null;
                        const etd = service.etd ? new Date(service.etd).getTime() : null;
                        const etdFormatted = formatTime(service.etd); // Format ETD time for display

                        const oneMinute = 60 * 1000; // 1 minute in milliseconds

                        if (service.isCancelled) {
                            statusBox.textContent = 'Cancelled';
                            statusBox.style.backgroundColor = '#d4351c'; // Red background
                            statusBox.style.color = 'white'; // White text
                        } else if (etd !== null && std !== null) {
                            if (etd > std) {
                                statusBox.textContent = `Exp ${etdFormatted}`;
                                statusBox.style.backgroundColor = '#d4351c'; // Red background
                                statusBox.style.color = 'white'; // White text
                            } else if (Math.abs(etd - std) <= oneMinute) {
                                statusBox.textContent = 'On Time';
                                statusBox.style.backgroundColor = 'white';
                                statusBox.style.color = 'black';
                            } else if (etd < std && std - etd <= 5 * oneMinute) { // Assuming "a few minutes" means up to 5 minutes
                                statusBox.textContent = 'Arrived';
                                statusBox.style.backgroundColor = 'white';
                                statusBox.style.color = 'black';
                            } else {
                                statusBox.textContent = 'Arrived'; // Default status for other cases
                                statusBox.style.backgroundColor = 'white'; // Red background
                                statusBox.style.color = 'black'; // White text
                            }
                        } else {
                            statusBox.textContent = 'N/A';
                            statusBox.style.backgroundColor = 'white';
                            statusBox.style.color = 'black';
                        }
                        console.log(`Status for section ${index + 1}: ${statusBox.textContent}`);

                        // Destination
                        const destination = service.destination && service.destination.length > 0 ? service.destination[0].locationName || 'N/A' : 'N/A';
                        section.querySelector('.destination').textContent = destination;
                        console.log(`Destination for section ${index + 1}: ${destination}`);

                        // Calling Points
                        const currentSubsequentLocations = service.subsequentLocations
                            .filter(location => !location.isPass) // Only locations where isPass is false
                            .map(loc => {
                                // Remove text within brackets
                                const cleanedName = loc.locationName.replace(/\s*\(.*?\)\s*/g, '');
                                const std = formatTime(loc.std);
                                const eta = formatTime(loc.eta);

                                // Use ETA for the last calling point, otherwise use STD
                                const timeToShow = loc === service.subsequentLocations[service.subsequentLocations.length - 1] ? eta : std;

                                // Truncate the location name if necessary
                                const truncatedName = truncateText(cleanedName, 17);

                                return `${truncatedName} (${timeToShow})`;
                            });

                        // Compare current calling points with the previous ones
                        if (!arraysEqual(previousSubsequentLocations[index] || [], currentSubsequentLocations)) {
                            previousSubsequentLocations[index] = currentSubsequentLocations;

                            // Split calling points into pages
                            const pageSize = 10;
                            const pages = [];
                            for (let i = 0; i < currentSubsequentLocations.length; i += pageSize) {
                                pages.push(currentSubsequentLocations.slice(i, i + pageSize));
                            }

                            // Update calling points
                            function updateCallingPoints() {
                                const page = pages[0] || [];
                                section.querySelector('.calling-points').innerHTML = page.map(loc => `<div>${loc}</div>`).join('');
                            }

                            updateCallingPoints(); // Initial call to show the first page

                            // Update calling points every 10 seconds
                            if (!section.hasAttribute('data-interval')) {
                                section.setAttribute('data-interval', setInterval(() => {
                                    pages.push(pages.shift()); // Move the first page to the end
                                    updateCallingPoints();
                                }, 10000));
                            }
                        }

                        // Operator
                        let operator = service.operator || 'N/A';
                        if (operator === 'West Midlands Trains') {
                            operator = 'London Northwestern Railway';
                        }
                        if (operator !== 'TransPennine Express') {
                            operator = truncateText(operator, 17);
                        }
                        section.querySelector('.toc').textContent = operator;
                        console.log(`Operator for section ${index + 1}: ${operator}`);

                        // Carriages (formation)
                        let formation = null;

                        // Check if formation and coaches array are available
                        if (service.formation && service.formation.coaches) {
                            // Count the number of coaches in the formation
                            formation = service.formation.coaches.length;
                        }

                        // Fallback to the 'length' field if no valid formation found
                        if (formation === null || formation === undefined) {
                            formation = service.length;
                        }

                        // Determine the display message based on formation
                        let displayText = '';
                        let textColor = 'yellow'; // Default color

                        if (formation === '0' || formation === null || formation === undefined) {
                            displayText = 'No coach length data';
                            textColor = 'black'; // Different color for "No data"
                        } else {
                            displayText = `${formation} carriages`;
                        }

                        // Set carriages text and color
                        section.querySelector('.carriages').style.color = textColor;
                        section.querySelector('.carriages').textContent = displayText;
                        console.log(`Formation for section ${index + 1}: ${displayText}`);
                    } else {
                        console.log(`No data available for section ${index + 1}`);
                    }
                });
            } else {
                console.log('No train services available.');
            }
        } catch (error) {
            console.error('Error fetching departures data:', error);
        }
    }

    // Helper function to check if two arrays are equal
    function arraysEqual(arr1, arr2) {
        if (arr1.length !== arr2.length) return false;
        for (let i = 0; i < arr1.length; i++) {
            if (arr1[i] !== arr2[i]) return false;
        }
        return true;
    }

    // Function to start updating both the departures and calling points
    function startUpdating(crsCode) {
        // Initial update
        updateDepartures(crsCode);
        // Set an interval to update every 10 seconds
        setInterval(() => updateDepartures(crsCode), 10000);
    }

    // Directly set the CRS code to "CAR" and start updating
    window.onload = function() {
        const crsCode = "EUS";
        startUpdating(crsCode); // Start updating departures and calling points for the CRS code "CAR"
    };
    </script>

</body>
</html>
